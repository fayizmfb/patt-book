{% extends "base.html" %}

{% block title %}My Credits - Patt Book{% endblock %}

{% block content %}
<div class="card">
    <h2 style="margin-bottom: 30px;">My Credit Balances</h2>
    
    {% if outstanding_by_retailer %}
    <div style="margin-bottom: 30px;">
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
            <h3 style="color: #666; margin-bottom: 10px;">Total Outstanding</h3>
            <div style="font-size: 2.5em; font-weight: bold; color: #dc3545;">â‚¹{{ "%.2f"|format(total_outstanding) }}</div>
        </div>
    </div>
    
    <h3 style="margin-bottom: 20px;">Store-wise Balances</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        {% for retailer in outstanding_by_retailer %}
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; cursor: pointer;" 
             onclick="window.location.href='{{ url_for('customer_retailer_detail', retailer_phone=retailer.retailer_phone) }}'">
            <h4 style="margin-bottom: 15px; color: #333;">{{ retailer.shop_name }}</h4>
            <div style="font-size: 1.5em; font-weight: bold; color: #dc3545; margin-bottom: 10px;">
                â‚¹{{ "%.2f"|format(retailer.outstanding) }}
            </div>
            <div style="color: #666; font-size: 0.9em;">{{ retailer.retailer_phone }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 4em; margin-bottom: 20px;">ðŸ’°</div>
        <h3 style="margin-bottom: 15px; color: #666;">No Outstanding Balances</h3>
        <p style="color: #999;">You don't have any credit outstanding with any retailers.</p>
    </div>
    {% endif %}
</div>

<script>
// Save FCM token for push notifications
function saveFCMToken() {
    // This function should be called from your mobile app
    // when FCM token is available
    if (typeof firebase !== 'undefined' && firebase.messaging()) {
        firebase.messaging().getToken().then(function(token) {
            if (token) {
                fetch('/customer/save-fcm-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'token': token
                    })
                }).then(function(response) {
                    console.log('FCM token saved:', response);
                }).catch(function(error) {
                    console.error('Error saving FCM token:', error);
                });
            }
        }).catch(function(error) {
            console.error('Error getting FCM token:', error);
        });
    }
}

// Auto-save token when page loads
document.addEventListener('DOMContentLoaded', function() {
    // For mobile apps, the token should be passed from native code
    if (window.FCM_TOKEN) {
        fetch('/customer/save-fcm-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'token': window.FCM_TOKEN
            })
        }).then(function(response) {
            console.log('FCM token saved:', response);
        }).catch(function(error) {
            console.error('Error saving FCM token:', error);
        });
    }
});
</script>

<style>
.outstanding {
    color: #dc3545;
    font-weight: bold;
}

.grid-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
